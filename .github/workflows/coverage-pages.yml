name: Test & Publish Coverage (Backend + Frontend)

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # Backend
      - name: Install backend deps
        run: |
          cd backend
          npm ci

      - name: Run backend tests
        run: |
          cd backend
          npm test

      # Frontend
      - name: Install frontend deps
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm test

      # Generate PDF reports using Puppeteer
      - name: Generate PDF reports
        run: |
          mkdir -p pdfs
          npm install puppeteer
          cat > convert-to-pdf.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          
          (async () => {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            try {
              // Backend Coverage PDF
              const backendPage = await browser.newPage();
              const backendPath = 'file://' + path.resolve('backend/coverage/index.html');
              await backendPage.goto(backendPath, { waitUntil: 'networkidle0', timeout: 60000 });
              await backendPage.pdf({ 
                path: 'pdfs/backend-coverage-report.pdf', 
                format: 'A4',
                margin: { top: '10mm', right: '10mm', bottom: '10mm', left: '10mm' }
              });
              await backendPage.close();
              console.log('✓ Backend PDF created');
              
              // Frontend Coverage PDF
              const frontendPage = await browser.newPage();
              const frontendPath = 'file://' + path.resolve('frontend/coverage/index.html');
              await frontendPage.goto(frontendPath, { waitUntil: 'networkidle0', timeout: 60000 });
              await frontendPage.pdf({ 
                path: 'pdfs/frontend-coverage-report.pdf', 
                format: 'A4',
                margin: { top: '10mm', right: '10mm', bottom: '10mm', left: '10mm' }
              });
              await frontendPage.close();
              console.log('✓ Frontend PDF created');
              
            } catch (error) {
              console.error('PDF Generation Error:', error);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
          node convert-to-pdf.js

      # Upload Coverage Artifacts (HTML + PDF)
      - name: Upload combined coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_id }}
          path: |
            backend/coverage/
            frontend/coverage/
            pdfs/
          retention-days: 90

      # Prepare Pages
      - name: Prepare Pages content
        run: |
          mkdir -p public/backend public/frontend
          cp -r backend/coverage/* public/backend/
          cp -r frontend/coverage/* public/frontend/

      # Deploy
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          cname: ""
